import { useState, useEffect } from 'react';
import { Search, BookOpen, ExternalLink, ChevronDown, ChevronUp } from 'lucide-react';

// 模拟定理数据库（使用纯文本公式）
const theorems = [
  {
    id: 1,
    name: "勾股定理",
    statement: "在直角三角形中，斜边的平方等于两直角边的平方和",
    formula: "设直角三角形三边为 a, b, c（斜边），则 a² + b² = c²",
    proof: `
      构造四个全等的直角三角形，拼成一个边长为(a+b)的正方形。
      内部小正方形面积为c²，四个三角形总面积为2ab。因此：
      (a+b)² = c² + 2ab 
      ⇒ a² + 2ab + b² = c² + 2ab 
      ⇒ a² + b² = c²
    `,
    references: [
      { title: "欧几里得《几何原本》", url: "https://zh.wikipedia.org/wiki/%E5%8F%A4%E5%B8%8C%E8%87%B4%E5%87%A0%E4%BD%95%E5%8E%9F%E6%9C%AC" },
      { title: "勾股定理证明合集", url: "https://www.cut-the-knot.org/pythagoras/" }
    ]
  },
  {
    id: 2,
    name: "均值不等式",
    statement: "对于任意正实数，算术平均数不小于几何平均数",
    formula: "设 a₁, a₂, ..., aₙ 为正实数，则 (a₁ + a₂ + ... + aₙ)/n ≥ ⁿ√(a₁a₂...aₙ)",
    proof: `
      使用数学归纳法：
      1. 当n=2时，(a₁+a₂)² ≥ 4a₁a₂ ⇒ (√a₁ - √a₂)² ≥ 0 成立
      2. 假设n=k时成立，证明n=2k时成立
      3. 通过调整系数证明n=k-1时成立
    `,
    references: [
      { title: "数学分析教程", url: "https://book.douban.com/subject/1084335/" },
      { title: "不等式证明技巧", url: "https://www.artofproblemsolving.com/wiki/index.php/Inequality" }
    ]
  },
  {
    id: 3,
    name: "微积分基本定理",
    statement: "定积分是导数的逆运算",
    formula: "若 F(x) 是 f(x) 的一个原函数，则 ∫ₐᵇ f(x)dx = F(b) - F(a)",
    proof: `
      将区间[a,b]分成n个小区间，每个小区间上用矩形近似积分。
      当n→∞时，黎曼和收敛于定积分值。
      通过中值定理可证明该极限等于F(b)-F(a)
    `,
    references: [
      { title: "托马斯微积分", url: "https://book.douban.com/subject/1086973/" },
      { title: "MIT微积分公开课", url: "https://ocw.mit.edu/courses/mathematics/18-01sc-single-variable-calculus-fall-2010/" }
    ]
  }
];

// 简单的公式渲染组件（使用CSS模拟LaTeX效果）
const SimpleLatexRenderer = ({ children }) => {
  return (
    <div className="inline-block bg-gray-50 px-2 py-1 rounded text-base font-mono text-gray-800 border border-gray-200">
      {children.replace(/\^(\d)/g, '<sup>$1</sup>').replace(/_(\d)/g, '<sub>$1</sub>')}
    </div>
  );
};

// 多行公式渲染
const MultiLineLatexRenderer = ({ children }) => {
  const lines = children.split('\n').filter(line => line.trim() !== '');
  return (
    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
      {lines.map((line, idx) => (
        <div key={idx} className="mb-2 last:mb-0">
          <SimpleLatexRenderer>{line.trim()}</SimpleLatexRenderer>
        </div>
      ))}
    </div>
  );
};

const MathTheoremExplorer = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedTheorem, setSelectedTheorem] = useState(null);
  const [filteredTheorems, setFilteredTheorems] = useState(theorems);

  useEffect(() => {
    const results = theorems.filter(theorem => 
      theorem.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      theorem.statement.toLowerCase().includes(searchTerm.toLowerCase())
    );
    setFilteredTheorems(results);
  }, [searchTerm]);

  return (
    <div className="max-w-4xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen">
      <div className="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h1 className="text-3xl font-bold text-center text-indigo-800 mb-6 flex items-center justify-center gap-2">
          <BookOpen className="text-indigo-600" /> 数学定理探索器
        </h1>
        
        <div className="relative mb-8">
          <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <Search className="text-gray-400" size={20} />
          </div>
          <input
            type="text"
            placeholder="搜索定理名称或内容..."
            className="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>

        {filteredTheorems.length === 0 ? (
          <div className="text-center text-gray-500 py-12">
            <p className="text-lg">未找到匹配的定理</p>
            <p className="text-sm mt-2">尝试不同的搜索关键词</p>
          </div>
        ) : (
          <div className="space-y-4">
            {filteredTheorems.map((theorem) => (
              <div 
                key={theorem.id} 
                className={`bg-gradient-to-r from-white to-blue-50 rounded-xl p-6 border border-blue-100 shadow-sm transition-all hover:shadow-md ${selectedTheorem?.id === theorem.id ? 'ring-2 ring-blue-400' : ''}`}
                onClick={() => setSelectedTheorem(selectedTheorem?.id === theorem.id ? null : theorem)}
              >
                <div className="flex justify-between items-start">
                  <h2 className="text-xl font-semibold text-blue-800">{theorem.name}</h2>
                  <button className="text-blue-600 hover:text-blue-800 transition flex items-center gap-1">
                    {selectedTheorem?.id === theorem.id ? (
                      <>
                        <ChevronUp size={16} /> 收起
                      </>
                    ) : (
                      <>
                        <ChevronDown size={16} /> 展开
                      </>
                    )}
                  </button>
                </div>
                
                <div className="mt-3 mb-4">
                  <p className="text-gray-700">{theorem.statement}</p>
                </div>
                
                {selectedTheorem?.id === theorem.id && (
                  <div className="space-y-4">
                    <div>
                      <h3 className="font-medium text-blue-700 mb-2">数学公式</h3>
                      <div className="flex items-center gap-2">
                        <SimpleLatexRenderer>{theorem.formula}</SimpleLatexRenderer>
                      </div>
                    </div>
                    
                    <div>
                      <h3 className="font-medium text-blue-700 mb-2">证明过程</h3>
                      <MultiLineLatexRenderer>{theorem.proof}</MultiLineLatexRenderer>
                    </div>
                    
                    {theorem.references.length > 0 && (
                      <div>
                        <h3 className="font-medium text-blue-700 mb-2">参考资料</h3>
                        <div className="space-y-2">
                          {theorem.references.map((ref, idx) => (
                            <a 
                              key={idx} 
                              href={ref.url} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 transition"
                            >
                              <ExternalLink size={16} />
                              {ref.title}
                            </a>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
      
      <div className="text-center text-gray-500 text-sm">
        <p>点击定理卡片展开详细内容 • 轻量级公式渲染</p>
      </div>
    </div>
  );
};

export default MathTheoremExplorer;
